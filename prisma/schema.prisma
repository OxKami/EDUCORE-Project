// Prisma Schema for EduCore
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MANAGEMENT
// ============================================

enum UserRole {
  ADMIN
  TEACHER
  STUDENT
  PARENT
  ACCOUNTANT
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

model User {
  id            String      @id @default(uuid())
  email         String      @unique
  username      String      @unique
  password      String
  role          UserRole
  status        UserStatus  @default(ACTIVE)
  firstName     String
  lastName      String
  phoneNumber   String?
  profileImage  String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  lastLogin     DateTime?

  teacher       Teacher?
  student       Student?
  parent        Parent?
  createdTransactions Transaction[] @relation("CreatedBy")
  documents     Document[]
  auditLogs     AuditLog[]

  @@index([email])
  @@index([username])
  @@index([role])
}

// ============================================
// ACADEMIC STRUCTURE
// ============================================

model AcademicYear {
  id          String      @id @default(uuid())
  name        String
  startDate   DateTime
  endDate     DateTime
  isCurrent   Boolean     @default(false)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  semesters   Semester[]
  enrollments Enrollment[]
  transactions Transaction[]

  @@index([isCurrent])
}

model Semester {
  id              String        @id @default(uuid())
  name            String
  academicYearId  String
  startDate       DateTime
  endDate         DateTime
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  academicYear    AcademicYear  @relation(fields: [academicYearId], references: [id])
  classSubjects   ClassSubject[]

  @@index([academicYearId])
}

model Grade {
  id          String      @id @default(uuid())
  name        String
  level       Int
  description String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  classes     Class[]
}

model Class {
  id          String      @id @default(uuid())
  name        String
  gradeId     String
  capacity    Int         @default(30)
  room        String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  grade       Grade       @relation(fields: [gradeId], references: [id])
  enrollments Enrollment[]
  subjects    ClassSubject[]

  @@index([gradeId])
}

model Subject {
  id          String      @id @default(uuid())
  name        String
  code        String      @unique
  description String?
  credits     Int         @default(1)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  classes     ClassSubject[]
  scores      Score[]

  @@index([code])
}

model ClassSubject {
  id          String      @id @default(uuid())
  classId     String
  subjectId   String
  teacherId   String
  semesterId  String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  class       Class       @relation(fields: [classId], references: [id])
  subject     Subject     @relation(fields: [subjectId], references: [id])
  teacher     Teacher     @relation(fields: [teacherId], references: [id])
  semester    Semester    @relation(fields: [semesterId], references: [id])
  scores      Score[]

  @@unique([classId, subjectId, semesterId])
  @@index([classId])
  @@index([teacherId])
}

// ============================================
// PEOPLE
// ============================================

model Teacher {
  id              String      @id @default(uuid())
  userId          String      @unique
  employeeId      String      @unique
  specialization  String?
  qualification   String?
  hireDate        DateTime
  salary          Decimal?    @db.Decimal(10, 2)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  subjects        ClassSubject[]

  @@index([employeeId])
}

model Student {
  id              String      @id @default(uuid())
  userId          String      @unique
  studentId       String      @unique
  dateOfBirth     DateTime
  gender          String
  address         String?
  enrollmentDate  DateTime    @default(now())
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  enrollments     Enrollment[]
  scores          Score[]
  parents         StudentParent[]
  transactions    Transaction[]

  @@index([studentId])
}

model Parent {
  id              String      @id @default(uuid())
  userId          String      @unique
  occupation      String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  children        StudentParent[]
}

model StudentParent {
  id              String      @id @default(uuid())
  studentId       String
  parentId        String
  relationship    String
  isPrimary       Boolean     @default(false)
  createdAt       DateTime    @default(now())

  student         Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  parent          Parent      @relation(fields: [parentId], references: [id], onDelete: Cascade)

  @@unique([studentId, parentId])
  @@index([studentId])
  @@index([parentId])
}

model Enrollment {
  id              String      @id @default(uuid())
  studentId       String
  classId         String
  academicYearId  String
  enrollmentDate  DateTime    @default(now())
  status          String      @default("ACTIVE")
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  student         Student     @relation(fields: [studentId], references: [id])
  class           Class       @relation(fields: [classId], references: [id])
  academicYear    AcademicYear @relation(fields: [academicYearId], references: [id])

  @@unique([studentId, classId, academicYearId])
  @@index([studentId])
  @@index([classId])
}

// ============================================
// GRADING SYSTEM
// ============================================

enum ScoreType {
  HOMEWORK
  QUIZ
  MIDTERM
  FINAL
  PROJECT
  PARTICIPATION
}

model Score {
  id              String      @id @default(uuid())
  studentId       String
  classSubjectId  String
  subjectId       String
  scoreType       ScoreType
  score           Decimal     @db.Decimal(5, 2)
  maxScore        Decimal     @db.Decimal(5, 2)
  weight          Decimal     @db.Decimal(3, 2)
  notes           String?
  dateRecorded    DateTime    @default(now())
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  student         Student     @relation(fields: [studentId], references: [id])
  classSubject    ClassSubject @relation(fields: [classSubjectId], references: [id])
  subject         Subject     @relation(fields: [subjectId], references: [id])

  @@index([studentId])
  @@index([classSubjectId])
}

// ============================================
// FINANCIAL MANAGEMENT
// ============================================

enum TransactionType {
  INCOME
  EXPENSE
}

enum PaymentCategory {
  TUITION_FEE
  LUNCH_FEE
  EXTRA_CLASS_FEE
  ENGLISH_CLASS_FEE
  UNIFORM
  BOOKS
  ACTIVITY_FEE
  SALARY
  UTILITIES
  MAINTENANCE
  SUPPLIES
  OTHER
}

enum PaymentStatus {
  PENDING
  COMPLETED
  CANCELLED
  REFUNDED
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  BCEL_ONE
  CREDIT_CARD
  OTHER
}

model Transaction {
  id              String          @id @default(uuid())
  type            TransactionType
  category        PaymentCategory
  amount          Decimal         @db.Decimal(10, 2)
  currency        String          @default("LAK")
  description     String
  paymentMethod   PaymentMethod?
  status          PaymentStatus   @default(COMPLETED)
  referenceNumber String?
  receiptNumber   String?         @unique
  
  studentId       String?
  academicYearId  String?
  
  transactionDate DateTime        @default(now())
  dueDate         DateTime?
  paidDate        DateTime?
  createdById     String
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  student         Student?        @relation(fields: [studentId], references: [id])
  academicYear    AcademicYear?   @relation(fields: [academicYearId], references: [id])
  createdBy       User            @relation("CreatedBy", fields: [createdById], references: [id])
  attachments     TransactionAttachment[]

  @@index([type])
  @@index([category])
  @@index([status])
  @@index([studentId])
  @@index([transactionDate])
}

model TransactionAttachment {
  id              String      @id @default(uuid())
  transactionId   String
  fileName        String
  filePath        String
  fileSize        Int
  mimeType        String
  uploadedAt      DateTime    @default(now())

  transaction     Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@index([transactionId])
}

// ============================================
// DOCUMENT MANAGEMENT
// ============================================

enum DocumentType {
  POLICY
  REPORT
  LETTER
  CERTIFICATE
  FORM
  CURRICULUM
  TEACHING_MATERIAL
  STUDENT_RECORD
  OTHER
}

enum DocumentAccessLevel {
  PUBLIC
  INTERNAL
  RESTRICTED
  CONFIDENTIAL
}

model Document {
  id              String              @id @default(uuid())
  title           String
  description     String?
  type            DocumentType
  accessLevel     DocumentAccessLevel @default(INTERNAL)
  fileName        String
  filePath        String
  fileSize        Int
  mimeType        String
  version         Int                 @default(1)
  tags            String[]
  
  uploadedById    String
  uploadedAt      DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  expiryDate      DateTime?

  uploadedBy      User                @relation(fields: [uploadedById], references: [id])

  @@index([type])
  @@index([accessLevel])
  @@index([uploadedById])
  @@index([uploadedAt])
}

// ============================================
// AUDIT LOGS
// ============================================

enum AuditAction {
  CREATE
  READ
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  EXPORT
  IMPORT
}

model AuditLog {
  id              String      @id @default(uuid())
  userId          String
  action          AuditAction
  entityType      String
  entityId        String?
  details         Json?
  ipAddress       String?
  userAgent       String?
  timestamp       DateTime    @default(now())

  user            User        @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([timestamp])
}

// ============================================
// SYSTEM CONFIGURATION
// ============================================

model SystemConfig {
  id              String      @id @default(uuid())
  key             String      @unique
  value           String
  description     String?
  category        String      @default("GENERAL")
  isPublic        Boolean     @default(false)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([category])
}